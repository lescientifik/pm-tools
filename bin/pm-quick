#!/usr/bin/env bash
# pm-quick - Quick PubMed search with pretty output
# Usage: pm-quick [OPTIONS] "search query"

set -euo pipefail

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/pm-common.sh
source "${SCRIPT_DIR}/../lib/pm-common.sh"

show_help() {
    cat << 'EOF'
pm-quick - Quick PubMed search with pretty output

Usage: pm-quick [OPTIONS] "search query"

Options:
  --max N         Maximum results (default: 100)
  -v, --verbose   Show progress on stderr
  -h, --help      Show this help message

Examples:
  pm-quick "CRISPR cancer therapy"
  pm-quick --max 20 "machine learning diagnosis"

For programmatic use (JSONL output), use the pipeline:
  pm-search "query" | pm-fetch | pm-parse
EOF
    exit 0
}

# Configuration
DEFAULT_MAX=100

# Parse arguments
max_results="$DEFAULT_MAX"
query=""
verbose=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --help|-h)
            show_help
            ;;
        --verbose|-v)
            verbose=true
            shift
            ;;
        --max)
            shift
            max_results="${1:-}"
            [[ -z "$max_results" ]] && die "Error: --max requires a number"
            shift
            ;;
        --max=*)
            max_results="${1#*=}"
            shift
            ;;
        -*)
            die "Unknown option: $1. Use --help for usage."
            ;;
        *)
            if [[ -n "$query" ]]; then
                die "Error: Only one query allowed. Use quotes for multi-word queries."
            fi
            query="$1"
            shift
            ;;
    esac
done

# Validate query
if [[ -z "$query" ]]; then
    echo "Error: Missing query argument" >&2
    echo "Usage: pm-quick [OPTIONS] \"search query\"" >&2
    exit 1
fi

if [[ -z "${query// /}" ]]; then
    die "Error: Query cannot be empty"
fi

# Run the pipeline with pretty output
if $verbose; then
    echo "Searching PubMed: \"$query\" (max $max_results)..." >&2
fi

"${SCRIPT_DIR}/pm-search" "$query" --max "$max_results" | \
    "${SCRIPT_DIR}/pm-fetch" | \
    "${SCRIPT_DIR}/pm-parse" | \
    "${SCRIPT_DIR}/pm-show"
