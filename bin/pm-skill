#!/usr/bin/env bash
# pm-skill - Install the pm-tools skill for Claude Code
# Usage: pm-skill [OPTIONS]

set -euo pipefail

show_help() {
    cat << 'EOF'
pm-skill - Install the pm-tools skill for Claude Code

Usage: pm-skill [OPTIONS]

Options:
  --global    Install to ~/.claude/skills/ (user-wide)
  --force     Overwrite existing skill
  -h, --help  Show this help

By default, installs to .claude/skills/ in the current directory.

Examples:
  pm-skill              # Install in current project
  pm-skill --global     # Install for all projects
  pm-skill --force      # Overwrite if exists
EOF
    exit 0
}

write_skill() {
    cat << 'SKILL_EOF'
---
name: using-pm-tools
description: Searches and parses PubMed articles using pm-tools CLI. Use when user asks about PubMed, scientific papers, literature search, downloading PDFs, or mentions any pm-* command (pm-search, pm-fetch, pm-parse, pm-filter, pm-show, pm-download, pm-diff).
---

# Using pm-tools

Unix-style CLI tools for PubMed: search -> fetch -> parse -> filter.

## Commands

| Command | Input | Output | Purpose |
|---------|-------|--------|---------|
| `pm-search` | Query | PMIDs | Search PubMed |
| `pm-fetch` | PMIDs | XML | Download article data |
| `pm-parse` | XML | JSONL | Extract structured fields |
| `pm-filter` | JSONL | JSONL | Filter by year/journal/author |
| `pm-show` | JSONL | Text | Pretty-print for humans |
| `pm-download` | JSONL | PDFs | Download Open Access PDFs |
| `pm-diff` | Two JSONL files | JSONL | Compare article collections |

## AI Workflow (REQUIRED)

**NEVER use `pm-quick`** - it's for human terminal use only.

**ALWAYS save results to files** to avoid re-querying PubMed API:

### Step 1: Search and cache results
```bash
# Save to project directory if research is relevant, otherwise /tmp
pm-search "QUERY" --max 50 | pm-fetch | pm-parse > results.jsonl
```

### Step 2: Browse titles first (prevent context flooding)
```bash
jq -r '{pmid, title}' results.jsonl
```

### Step 3: Drill into specific articles if needed
```bash
# Get abstract for specific PMID
jq -r 'select(.pmid == "12345678") | .abstract' results.jsonl

# Or get full details for a few articles
jq -r 'select(.pmid == "12345678" or .pmid == "87654321")' results.jsonl
```

### Step 4: Apply filters as needed
```bash
pm-filter --year 2024- --has-abstract < results.jsonl > filtered.jsonl
jq -r '{pmid, title}' filtered.jsonl
```

## File Naming Convention

```bash
# Temporary exploration
/tmp/pubmed-$(date +%Y%m%d-%H%M%S).jsonl

# Research the user wants to keep
./pubmed-TOPIC.jsonl           # e.g., pubmed-crispr-therapy.jsonl
./data/pubmed-TOPIC.jsonl      # if data/ directory exists
```

## Common Patterns

### Initial exploration
```bash
pm-search "CRISPR therapy" --max 30 | pm-fetch | pm-parse > /tmp/crispr.jsonl
jq -r '{pmid, title}' /tmp/crispr.jsonl
```

### Narrow down by year
```bash
pm-filter --year 2024- < /tmp/crispr.jsonl | jq -r '{pmid, title, year}'
```

### Read specific abstracts
```bash
jq -r 'select(.pmid == "39341234") | "\(.title)\n\n\(.abstract)"' /tmp/crispr.jsonl
```

### Export for user
```bash
jq -r '[.pmid, .year, .journal, .title] | @csv' results.jsonl > papers.csv
```

### Compare collections
```bash
pm-diff old.jsonl new.jsonl | jq -r 'select(.status=="added") | .pmid'
```

## Output Format (JSONL)

```json
{
  "pmid": "12345678",
  "title": "Article title",
  "authors": ["Smith John", "Doe Jane"],
  "journal": "Nature",
  "year": "2024",
  "doi": "10.1038/xxxxx",
  "abstract": "Full abstract..."
}
```

## Filter Options

```bash
pm-filter --year 2024           # Exact year
pm-filter --year 2020-2024      # Range
pm-filter --year 2020-          # 2020 onwards
pm-filter --journal nature      # Case-insensitive
pm-filter --author zhang        # Any author matches
pm-filter --has-abstract        # Must have abstract
pm-filter --has-doi             # Must have DOI
```

## Human Commands (NOT for AI)

`pm-quick` and `pm-show` produce pretty output for humans reading terminals.
AI should read JSONL directly with `jq` for structured access.

## Notes

- Rate limit: 3 req/sec (automatic)
- Batch size: 200 PMIDs per fetch
- Use `--max N` to limit search results
- **Always cache to file** - never run the same query twice
SKILL_EOF
}

# Defaults
GLOBAL=false
FORCE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            ;;
        --global)
            GLOBAL=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage information." >&2
            exit 1
            ;;
        *)
            echo "Unknown argument: $1" >&2
            echo "Use --help for usage information." >&2
            exit 1
            ;;
    esac
done

# Determine target directory
if [[ "$GLOBAL" == "true" ]]; then
    TARGET_DIR="$HOME/.claude/skills/using-pm-tools"
else
    TARGET_DIR=".claude/skills/using-pm-tools"
fi

SKILL_FILE="$TARGET_DIR/SKILL.md"

# Check for existing skill
EXISTED=false
if [[ -f "$SKILL_FILE" ]]; then
    if [[ "$FORCE" != "true" ]]; then
        echo "Error: Skill already exists at $TARGET_DIR/" >&2
        echo "Use --force to overwrite." >&2
        exit 1
    fi
    EXISTED=true
fi

# Create directory and write skill
mkdir -p "$TARGET_DIR"
write_skill > "$SKILL_FILE"

if [[ "$EXISTED" == "true" ]]; then
    echo "Overwritten: $SKILL_FILE"
else
    echo "Created: $SKILL_FILE"
fi
