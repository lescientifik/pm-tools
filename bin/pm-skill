#!/usr/bin/env bash
# pm-skill - Install the pm-tools skill for Claude Code
# Usage: pm-skill [OPTIONS]

set -euo pipefail

show_help() {
    cat << 'EOF'
pm-skill - Install the pm-tools skill for Claude Code

Usage: pm-skill [OPTIONS]

Options:
  --global    Install to ~/.claude/skills/ (user-wide)
  --force     Overwrite existing skill
  -h, --help  Show this help

By default, installs to .claude/skills/ in the current directory.

Examples:
  pm-skill              # Install in current project
  pm-skill --global     # Install for all projects
  pm-skill --force      # Overwrite if exists
EOF
    exit 0
}

write_skill() {
    cat << 'SKILL_EOF'
---
name: using-pm-tools
description: Searches and parses PubMed articles using pm-tools CLI. Use when user asks about PubMed, scientific papers, literature search, downloading PDFs, or mentions any pm-* command (pm-search, pm-fetch, pm-parse, pm-filter, pm-show, pm-download, pm-quick, pm-diff).
---

# Using pm-tools

Unix-style CLI tools for PubMed: search -> fetch -> parse -> filter.

## Commands

| Command | Input | Output | Purpose |
|---------|-------|--------|---------|
| `pm-search` | Query | PMIDs | Search PubMed |
| `pm-fetch` | PMIDs | XML | Download article data |
| `pm-parse` | XML | JSONL | Extract structured fields |
| `pm-filter` | JSONL | JSONL | Filter by year/journal/author |
| `pm-show` | JSONL | Text | Pretty-print articles |
| `pm-download` | JSONL | PDFs | Download Open Access PDFs |
| `pm-quick` | Query | Text | One-command search to pretty output |
| `pm-diff` | Two JSONL files | Report | Compare article collections |

## Basic Pipeline

```bash
pm-search "QUERY" | pm-fetch | pm-parse | jq '.title'
```

## Common Patterns

### Search and display titles
```bash
pm-search "CRISPR therapy" --max 10 | pm-fetch | pm-parse | jq -r '.title'
```

### Filter recent papers
```bash
pm-search "machine learning" --max 50 | pm-fetch | pm-parse | pm-filter --year 2024-
```

### Pretty-print results
```bash
pm-search "cancer" --max 5 | pm-fetch | pm-parse | pm-show
```

### Download PDFs
```bash
pm-search "open access[filter] AND genomics" --max 10 | pm-fetch | pm-parse | pm-download --output-dir ./pdfs/
```

### Export to CSV
```bash
pm-search "alzheimer" --max 100 | pm-fetch | pm-parse | \
  jq -r '[.pmid, .year, .journal, .title] | @csv' > papers.csv
```

### Quick one-command search
```bash
pm-quick "CRISPR therapy"               # Pretty output, default 100 results
pm-quick --max 20 "machine learning"    # Limit results
```

### Compare article collections
```bash
pm-diff old.jsonl new.jsonl             # Stream differences as JSONL
pm-diff old.jsonl new.jsonl | jq -r 'select(.status=="added") | .pmid'  # New PMIDs
pm-diff old.jsonl new.jsonl --quiet && echo "identical"  # Check if same
```

## Output Format (JSONL)

```json
{
  "pmid": "12345678",
  "title": "Article title",
  "authors": ["Smith John", "Doe Jane"],
  "journal": "Nature",
  "year": "2024",
  "doi": "10.1038/xxxxx",
  "abstract": "Full abstract..."
}
```

## Filter Options

```bash
pm-filter --year 2024           # Exact year
pm-filter --year 2020-2024      # Range
pm-filter --year 2020-          # 2020 onwards
pm-filter --journal nature      # Case-insensitive
pm-filter --author zhang        # Any author matches
pm-filter --has-abstract        # Must have abstract
pm-filter --has-doi             # Must have DOI
```

## Notes

- Rate limit: 3 req/sec (automatic)
- Batch size: 200 PMIDs per fetch
- Use `--max N` to limit search results
- Use `--verbose` for progress on large operations
SKILL_EOF
}

# Defaults
GLOBAL=false
FORCE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            ;;
        --global)
            GLOBAL=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage information." >&2
            exit 1
            ;;
        *)
            echo "Unknown argument: $1" >&2
            echo "Use --help for usage information." >&2
            exit 1
            ;;
    esac
done

# Determine target directory
if [[ "$GLOBAL" == "true" ]]; then
    TARGET_DIR="$HOME/.claude/skills/using-pm-tools"
else
    TARGET_DIR=".claude/skills/using-pm-tools"
fi

SKILL_FILE="$TARGET_DIR/SKILL.md"

# Check for existing skill
EXISTED=false
if [[ -f "$SKILL_FILE" ]]; then
    if [[ "$FORCE" != "true" ]]; then
        echo "Error: Skill already exists at $TARGET_DIR/" >&2
        echo "Use --force to overwrite." >&2
        exit 1
    fi
    EXISTED=true
fi

# Create directory and write skill
mkdir -p "$TARGET_DIR"
write_skill > "$SKILL_FILE"

if [[ "$EXISTED" == "true" ]]; then
    echo "Overwritten: $SKILL_FILE"
else
    echo "Created: $SKILL_FILE"
fi
