#!/usr/bin/env bash
# pm-search - Search PubMed and return PMIDs
# Usage: pm-search [--max N] "search query"

set -euo pipefail

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/pm-common.sh
source "${SCRIPT_DIR}/../lib/pm-common.sh"

# Configuration
ESEARCH_URL="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi"
DEFAULT_MAX=10000

# Parse arguments
max_results="$DEFAULT_MAX"
query=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --max)
            shift
            max_results="${1:-}"
            [[ -z "$max_results" ]] && die "Error: --max requires a number"
            shift
            ;;
        --max=*)
            max_results="${1#*=}"
            shift
            ;;
        -*)
            die "Unknown option: $1"
            ;;
        *)
            # First non-option argument is the query
            query="$1"
            shift
            ;;
    esac
done

# Validate query
if [[ -z "$query" ]]; then
    die "Usage: pm-search [--max N] \"search query\""
fi

# URL-encode the query (basic encoding for common characters)
encoded_query=$(echo -n "$query" | sed 's/ /%20/g; s/"/%22/g; s/#/%23/g; s/&/%26/g; s/+/%2B/g')

# Call esearch API
response=$(curl -s "${ESEARCH_URL}?db=pubmed&term=${encoded_query}&retmax=${max_results}&retmode=xml")

# Parse XML to extract IDs (one per line)
# Use || true to handle no matches (grep returns 1 when no match)
echo "$response" | grep -oP '<Id>\K[0-9]+(?=</Id>)' || true
