#!/usr/bin/env bash
# pm-show - Pretty print pm-parse JSONL output
# Usage: pm-parse articles.xml | pm-show
#        pm-search "query" | pm-fetch | pm-parse | pm-show

set -euo pipefail

# Parse arguments
FORCE_COLOR=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --color)
            FORCE_COLOR=1
            shift
            ;;
        --no-color)
            FORCE_COLOR=0
            shift
            ;;
        -h|--help)
            echo "pm-show - Pretty print pm-parse JSONL output"
            echo ""
            echo "Usage: pm-parse | pm-show [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --color      Force colored output (for piping to less -R, bat, etc.)"
            echo "  --no-color   Disable colors"
            echo "  -h, --help   Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

# Colors: auto-detect unless forced
use_color=0
if [[ "$FORCE_COLOR" == "1" ]]; then
    use_color=1
elif [[ "$FORCE_COLOR" == "0" ]] || [[ -n "${NO_COLOR:-}" ]]; then
    use_color=0
elif [[ -t 1 ]]; then
    use_color=1
fi

if [[ "$use_color" == "1" ]]; then
    BOLD='\033[1m'
    DIM='\033[2m'
    CYAN='\033[36m'
    YELLOW='\033[33m'
    GREEN='\033[32m'
    RESET='\033[0m'
else
    BOLD='' DIM='' CYAN='' YELLOW='' GREEN='' RESET=''
fi

# Process each JSON line
while IFS= read -r line; do
    # Parse JSON fields
    pmid=$(echo "$line" | jq -r '.pmid // "?"')
    title=$(echo "$line" | jq -r '.title // "No title"')
    journal=$(echo "$line" | jq -r '.journal // "Unknown journal"')
    date=$(echo "$line" | jq -r '.date // .year // "?"')
    doi=$(echo "$line" | jq -r '.doi // empty')
    authors=$(echo "$line" | jq -r '(.authors // [])[0:3] | join(", ")')
    author_count=$(echo "$line" | jq -r '(.authors // []) | length')
    abstract=$(echo "$line" | jq -r '.abstract // empty')

    # Print formatted output
    echo -e "${DIM}────────────────────────────────────────────────────────────────────────────────${RESET}"
    echo -e "${BOLD}${title}${RESET}"
    echo ""
    echo -e "  ${CYAN}${journal}${RESET} ${DIM}(${date})${RESET}"
    echo -e "  ${GREEN}PMID: ${pmid}${RESET}${doi:+  •  DOI: $doi}"
    if [[ -n "$authors" ]]; then
        suffix=""
        [[ "$author_count" -gt 3 ]] && suffix=" et al."
        echo -e "  ${YELLOW}${authors}${suffix}${RESET}"
    fi
    if [[ -n "$abstract" ]]; then
        echo ""
        echo -e "  ${DIM}${abstract}${RESET}"
    fi
    echo ""
done
