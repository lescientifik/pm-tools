#!/usr/bin/env bash
# pm-fetch - Fetch PubMed XML from E-utilities API
# Usage: echo "12345" | pm-fetch > articles.xml

set -euo pipefail

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/pm-common.sh
source "${SCRIPT_DIR}/../lib/pm-common.sh"

# Check dependencies
require_commands curl

show_help() {
    cat << 'EOF'
pm-fetch - Fetch PubMed XML from E-utilities API

Usage: echo "12345" | pm-fetch > articles.xml
       cat pmids.txt | pm-fetch > articles.xml

Options:
  -h, --help     Show this help message

Input:
  PMIDs from stdin, one per line

Output:
  PubMed XML to stdout

Features:
  - Batches requests (200 PMIDs per API call)
  - Rate limits to ~3 requests/second
  - Exits with error on network failure

Examples:
  # Fetch single article
  echo "12345" | pm-fetch > article.xml

  # Fetch from file
  cat pmids.txt | pm-fetch > articles.xml

  # Full pipeline
  pm-search "CRISPR" | pm-fetch | pm-parse > results.jsonl
EOF
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --help|-h)
            show_help
            ;;
        *)
            die "Unknown option: $1. Use --help for usage."
            ;;
    esac
done

# Configuration
EFETCH_URL="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi"
BATCH_SIZE=200
RATE_LIMIT_DELAY=0.34  # ~3 requests per second

# Read all PMIDs into array
pmid_list=()
while IFS= read -r line || [[ -n "$line" ]]; do
    # Skip empty lines
    [[ -z "$line" ]] && continue
    pmid_list+=("$line")
done

# If no PMIDs, exit cleanly
if [[ ${#pmid_list[@]} -eq 0 ]]; then
    exit 0
fi

# Fetch in batches
batch_num=0
for ((i = 0; i < ${#pmid_list[@]}; i += BATCH_SIZE)); do
    # Rate limiting: wait between requests (except first)
    if ((batch_num > 0)); then
        sleep "$RATE_LIMIT_DELAY"
    fi
    batch_num=$((batch_num + 1))

    # Build comma-separated list for this batch
    batch_pmids=""
    for ((j = i; j < i + BATCH_SIZE && j < ${#pmid_list[@]}; j++)); do
        if [[ -z "$batch_pmids" ]]; then
            batch_pmids="${pmid_list[j]}"
        else
            batch_pmids="${batch_pmids},${pmid_list[j]}"
        fi
    done

    # Fetch this batch
    curl -s "${EFETCH_URL}?db=pubmed&id=${batch_pmids}&rettype=abstract&retmode=xml"
done
